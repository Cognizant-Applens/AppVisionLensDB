/***************************************************************************
*COGNIZANT CONFIDENTIAL AND/OR TRADE SECRET
*Copyright [2018] – [2021] Cognizant. All rights reserved.
*NOTICE: This unpublished material is proprietary to Cognizant and
*its suppliers, if any. The methods, techniques and technical
  concepts herein are considered Cognizant confidential and/or trade secret information. 
  
*This material may be covered by U.S. and/or foreign patents or patent applications. 
*Use, distribution or copying, in whole or in part, is forbidden, except by express written permission of Cognizant.
***************************************************************************/

-- AppVisionLens - App Lens DB, [AVMDART] - AVM DART DB

--SELECT * from AVL.MAS_ProjectMaster where ProjectID=4321
-- DataMigration_ScreenAccess '548788,575633,371789,383323,548788,627384','1220264,1204036,1200960,1201096,1200885,1229409,1202377,1230552,1230048,1230064'
---'548788,575633,371789,383323,548788,627384'

-- UAT Region
-- Rukmini and Sivasankari 
-- EXEC SP_DataMigration_ScreenAccess '132399,519410', '1200126,1200248,1200372,1200531,1200847,1200885,1201032,1202592,1202889,1202979,1202994,1203222,1203458,1203595,1203944,1204613,1204833,1205379,1207772,1211235,1211720,1215218,1215219,1215898,1216698,1216727,1217951,1218008,1218157,1218391,1224062', '1000165237,1000212729,1000196109,1000162910,1000173143,1000159033,1000216610,1000143075,1000131053,1000039975,1000206883,1000213920,1000065827,1000199101,1000108066,1000164122,1000198463,1000175360,1000198148,1000198149,1000122124,1000067129,1000200753,1000189131,1000096627,1000096621,1000152864,1000086646,1000224320,1000120890,1000212543,1000223452,1000214065,1000106941,1000141325,1000208330,1000004197,1000003632,1000153592,1000186157,1000213808,1000008502,1000122125,1000181744' 
-- Viji and Sathya
-- EXEC SP_DataMigration_ScreenAccess '215573,323477', '1200096,1200910,1200960,1202064,1202614,1202620,1202663,1202771,1204198,1205875,1208105,1211691,1216093,1218877,1218897,1220012,1220264,1220650,1221285,1222953,1227363', '1000226999,1000213272,1000012968,1000192868,1000213345,1000215938,1000200571,1000200601,1000165242,1000200945,1000139632,1000178175,1000175651,1000125029,1000098697,1000216463,1000062599,1000145607,1000194794,1000189163,1000192778,1000213684,1000070731,1000221316,1000195860,1000198913,1000201934,1000201999,1000217758,1000083604,1000193310' 
-- EXEC SP_DataMigration_ScreenAccess '215573,323477', '1222953,', '1000219016'
-- EXEC SP_DataMigration_ScreenAccess '215573,323477', '1221285', '1000213272'
-- EXEC SP_DataMigration_ScreenAccess '371789', '1222953,1221285,1202614,1202064', '1000219016,1000213272,1000216463,1000098697'
-- Kodeeshwara Prabhu
-- EXEC SP_DataMigration_ScreenAccess '245829', '1200020,1200130,1200314,1200847,1201096,1201162,1201614,1202237,1202676,1202979,1203234,1203971,1205213,1205379,1208545,1208827,1215193,1215219,1215228,1215971,1216291,1218726,1220387,1221450,1229972,1230064,1230112,1230252,1230256,1233831', '1000196539,1000184738,1000205795,1000174509,1000165665,1000199552,1000113266,1000221184,1000174334,1000177296,1000170684,1000176890,1000191949,1000191270,1000216936,1000225229,1000225227,1000221825,1000000454,1000210966,1000227840,1000136257,1000196621,1000202438,1000097637,1000195705,1000137518,1000207669,1000227057,1000204975,1000205005,1000146292,1000165864,1000226413,1000178595,1000214958,1000165961,1000143123,1000194547,1000024363,1000220059'

-- Wave 2 Projects Access
-- EXEC SP_DataMigration_ScreenAccess '215573', '1200020,1200096,1200126,1200847,1200960,1202064,1202614,1202979,1204036,1204198,1204833,1205379,1205875,1206405,1208105,1208545,1214862,1215228,1215971,1216093,1216763,1218726,1218877,1218897,1220387,1220650,1220651,1220822,1221065,1221285,1222755,1222949,1222953,1225400,1226840,1228291,1228407,1228414,1229230,1229746,1230194,1232129,1232377', '1000020708,1000062381,1000070731,1000083604,1000097637,1000098697,1000106941,1000139704,1000139883,1000139892,1000144003,1000146292,1000152418,1000165954,1000166227,1000166230,1000176513,1000189163,1000192868,1000193310,1000194328,1000194927,1000195860,1000196109,1000196456,1000196539,1000198913,1000199101,1000199736,1000200945,1000201098,1000201934,1000201999,1000202438,1000205069,1000207521,1000211592,1000213004,1000213272,1000213345,1000213857,1000214958,1000215242,1000216463,1000216936,1000217312,1000217758,1000218366,1000219016,1000219168,1000220059,1000225227,1000225229,1000225877,1000226999,1000227840,1000232146'
-- Wave 2 Projects Access (Slot 2)
-- EXEC SP_DataMigration_ScreenAccess '215573', '1200314,1200372,1200531,1200847,1201614,1202237,1202592,1202676,1202889,1202979,1203390,1203458,1203971,1204198,1206639,1211235,1211691,1211720,1215193,1215219,1215898,1216097,1216291,1216698,1217951,1218391,1220139,1220264,1220650,1221926,1222441,1222926,1223634,1223666,1224104,1224243,1224704,1224871,1225292,1226346,1226705,1227363,1228307,1228524,1228569,1229409,1229433,1229972,1229990,1230000,1230064,1230100,1230229,1230252,1230256,1230552', '1000000454,1000003632,1000004197,1000012968,1000024363,1000039975,1000067129,1000081050,1000086646,1000096621,1000096627,1000097894,1000108066,1000121556,1000125029,1000133357,1000136257,1000137679,1000143016,1000143123,1000153592,1000154162,1000159033,1000161258,1000162438,1000163582,1000164122,1000165237,1000165242,1000165665,1000165961,1000168772,1000170684,1000174334,1000174509,1000175651,1000176890,1000177296,1000178595,1000184831,1000186157,1000191270,1000191949,1000194547,1000196621,1000197718,1000198148,1000198149,1000198441,1000198463,1000198836,1000199234,1000200461,1000200571,1000201709,1000201747,1000201748,1000210966,1000212729,1000213318,1000213342,1000213767,1000213808,1000214084,1000215228,1000215485,1000215938,1000216610,1000217820,1000223841,1000224091,1000224914,1000227057'
-- Wave 2 Projects Access (Slot 3)
-- EXEC SP_DataMigration_ScreenAccess '215573,659978', '1221627', '1000179446'

CREATE PROC [dbo].[SP_DataMigration_ScreenAccess]
(
	@UserID NVARCHAR(MAX),
	@CustomerID NVARCHAR(MAX), -- ESA Account IDs
	@ESAProjectIDs NVARCHAR(MAX) = NULL
)

AS
BEGIN

	DECLARE @LoopcountUser INT,
			@LoopcountAccount INT,
			@CountUserIDs INT,
			@CountAccount INT,
			@UserIDEach NVARCHAR(100),
			@AccountID BIGINT,
			@ProjectID BIGINT

	SELECT ROW_NUMBER() OVER (ORDER BY Item ASC) AS RowNo, Item AS UserID
	INTO #UserIDs 
	FROM SPLIT(@UserID, ',')

	SELECT ROW_NUMBER() OVER (ORDER BY Item ASC) AS RowNo, Item AS AccountID 
	INTO #AccountIDs 
	FROM SPLIT(@CustomerID, ',')

	UPDATE AC SET AccountID = Cust.CustomerID
	FROM #AccountIDs AC 
	JOIN AVL.Customer (NOLOCK) Cust 
		ON Cust.ESA_AccountID = AC.AccountID

	SET @CountUserIDs = (SELECT COUNT(*) FROM #UserIDs )
	SET @CountAccount = (SELECT COUNT(*) FROM #AccountIDs )
	
	SET @LoopcountUser = 1

	WHILE(@LoopcountUser <= @CountUserIDs) -- Loop User
	BEGIN

		SELECT @UserIDEach = UserID FROM #UserIDs WHERE Rowno = @LoopcountUser 
		SET @LoopcountAccount = 1

		WHILE(@LoopcountAccount <= @CountAccount) -- Loop Account
		BEGIN

			SELECT @AccountID = AccountID FROM #AccountIDs WHERE Rowno = @LoopcountAccount
	
			EXEC [dbo].[SaveCustomerScreenAccess] 'SaveAccess', @AccountID, 1, 1, @UserIDEach
			EXEC [dbo].[SaveCustomerScreenAccess] 'SaveAccess', @AccountID, 2, 1, @UserIDEach
			EXEC [dbo].[SaveCustomerScreenAccess] 'SaveAccess', @AccountID, 3, 1, @UserIDEach
			EXEC [dbo].[SaveCustomerScreenAccess] 'SaveAccess', @AccountID, 4, 1, @UserIDEach
			EXEC [dbo].[SaveCustomerScreenAccess] 'SaveAccess', @AccountID, 5, 1, @UserIDEach

			DECLARE @CountProjects INT, 
					@LoopProjects INT

			SET @LoopProjects = 1

			SELECT ROW_NUMBER() OVER (ORDER BY PM.ProjectID ASC) AS RowNo, PM.ProjectID AS ProjectID  
			INTO #TMPProject 
			FROM AVL.MAS_ProjectMaster (NOLOCK) PM
			JOIN #AccountIDs ACP1 ON PM.CustomerID = ACP1.AccountID
			JOIN AVL.Customer (NOLOCK) CUST 
				ON CUST.CustomerID = ACP1.AccountID
			--JOIN AVMDART.MAS.ProjectMaster (NOLOCK) PRJAVM 
			--	ON PRJAVM.ESAProjectID = PM.ESAProjectID 
			WHERE ACP1.RowNo = @LoopcountAccount AND (@ESAProjectIDs IS NULL OR 
				PM.ESAProjectID IN (SELECT Item FROM SPLIT(@ESAProjectIDs, ',')))

			SET @CountProjects = (SELECT COUNT(*) FROM #TMPProject)
			
			WHILE(@LoopProjects <= @CountProjects) -- Loop Project
			BEGIN

				 SELECT @ProjectID = ProjectID FROM #TMPProject WHERE Rowno = @LoopProjects 
			
				 EXEC [dbo].[usp_InsertRolesByEmployeeCustomer] @UserIDEach, @AccountID, @ProjectID
	
				 SET @LoopProjects = @LoopProjects + 1

				 -- Give Ticketing Module Access in App Lens
				 DECLARE @EmployeeName NVARCHAR(MAX)
				 DECLARE @EmployeeEmail NVARCHAR(MAX)

				 SELECT TOP 1 @EmployeeName = EmployeeName FROM AVL.MAS_LoginMaster (NOLOCK) WHERE EmployeeID = @UserIDEach
				 SELECT TOP 1 @EmployeeEmail = EmployeeEmail FROM AVL.MAS_LoginMaster (NOLOCK) WHERE EmployeeID = @UserIDEach

				 INSERT INTO AVL.MAS_LoginMaster 
				 (
					EmployeeID,  ClientUserID, EmployeeName, EmployeeEmail, ProjectID, CustomerID, HcmSupervisorID,
					TSApproverID, ManagerID, Remarks, EffectiveDate, TimeZoneId, MandatoryHours, EffectiveEndDate,     
					Billability_type, LocationID, IsDeleted, RoleID, IsAutoassignedTicket, ServiceLevelID,       
					CreatedDate, CreatedBy, ModifiedDate, ModifiedBy, TicketingModuleEnabled, IsDefaultProject,    
					IsEffortTrackingEnabled, Offshore_Onsite, IsNonESAAuthorized
				)
				VALUES
				(
					@UserIDEach, @UserIDEach, @EmployeeName, @EmployeeEmail, @ProjectID, @AccountID, @UserIDEach, 
					@UserIDEach, NULL, NULL, NULL, NULL, NULL, NULL, 
					NULL, 712, 0, 1, 'Y', NULL, 
					GETDATE(), @UserIDEach, NULL, NULL, NULL, NULL, NULL, NULL, NULL
				)

				---- Give Ticketing Module Access in AVM DART
				--DECLARE @DARTProjectID NVARCHAR(MAX)

				--SELECT TOP 1 @DARTProjectID = AVMPM.ProjectID 
				--FROM AVMDART.MAS.ProjectMaster (NOLOCK) AVMPM
				--JOIN AVL.MAS_ProjectMaster (NOLOCK) AVLPM ON AVLPM.ESAProjectID = AVMPM.ESAProjectID
				--	AND AVLPM.ProjectID = @ProjectID
				--WHERE ISNULL(AVMPM.IsDeleted, 'N') = 'N'  
				
				--INSERT INTO AVMDART.PRJ.LoginMaster
				--(
				--	cognizantID, ClientUserID, CognizantName, CognizantEmail, HcmSupervisorID, TsSupervisorID, ManagerID, LocationID, IsDeleted,
				--	GradeID, Designation, ProjectID, CreatedDateTime, CreatedBY, ModifiedDateTime, ModifiedBY, DeptAccountID, ClientEmailID,
				--	Project_type, associate_Billability_type, IsDefaultProject, IsWidgetDefaultProject, IsAutoassignedTicket, Default_page,
				--	NextTsSubmittedDate, Remarks, EffectiveDate, TimeZoneId, MandatoryHours, EffectiveEndDate
				--)
				--VALUES
				--(
				--	@UserIDEach, @UserIDEach, @EmployeeName, @EmployeeEmail, NULL, @UserIDEach, @UserIDEach, 5100, 'N', 
				--	3, NULL, @DARTProjectID, GETDATE(), @UserIDEach, GETDATE(), @UserIDEach, NULL, NULL, 
				--	NULL, 'BFD', 'Y', 'N', 'Y', '/Dashboard', 
				--	'2018-06-27 00:00:00.000', NULL, '2015-07-22', 32,0.00, '2018-12-31'
				--)

			END

			DROP TABLE #TMPProject
			SET @LoopcountAccount = @LoopcountAccount + 1

		END

		SET @LoopcountUser = @LoopcountUser + 1
	END

END
